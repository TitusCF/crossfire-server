VPATH = @srcdir@
srcdir = @srcdir@

RM=@RM@
BASENAME = @BASENAME@

SUBDIRS = playbook spoiler spell-docs spoiler-html playbook-html

PFILES = Makefile.in Crossedit.doc PlayerStats Protocol RandomMaps.doc \
	README RunTimeCommands Styles.doc \
	SurvivalGuide alchemy.doc crossedit.man crossfire.doc crossfire.man \
	crosslib.doc experience include_html.pl	mapguide metaserver \
	mapmakers_guide_to_runes multigod programming_guide \
	skills.doc skills_developer.doc spell_params.doc spell-paths \
	spellcasters_guide_to_runes spells teleporter.doc 

FILES = $(PFILES) handbook.ps spoiler.ps

prefix = @prefix@
exec_prefix = @exec_prefix@
mandir = @mandir@
MAN1 = $(mandir)/man6
MANSUFFIX = 6

INSTALL = @INSTALL@

MKDIR = @MKDIR@
SHELL = @BOURNE_SHELL@

all: spoiler.ps handbook.ps

spoiler.ps:
	(cd spoiler; $(MAKE) $(MFLAGS) spoiler)

handbook.ps:
	(cd playbook; $(MAKE) $(MFLAGS) handbook)

crosslib.doc:
	(cd ../common; make doc)

depend::

clean::

distclean:: clean
	@for dir in $(SUBDIRS); \
	do \
	    (echo "making distclean in $$dir..."; \
	    cd $$dir; $(MAKE) $(MFLAGS) 'MFLAGS=$(MFLAGS)' 'ARCHIVE=$(ARCHIVE)' 'VERSION=$(VERSION)' 'MKDIR=$(MKDIR)' 'CP=$(CP)' 'RM=$(RM)' distclean;) \
	done;
	$(RM) -f Makefile


archive:
	@if [ ! -d $(ARCHIVE)/doc ]; then $(MKDIR) $(ARCHIVE)/doc; fi
	$(CP) $(FILES) $(ARCHIVE)/doc
	@for dir in $(SUBDIRS); \
	do \
	    echo "making archive in $$dir..."; \
	    $(MAKE) -C $$dir $(MFLAGS) 'MFLAGS=$(MFLAGS)' 'ARCHIVE=$(ARCHIVE)' 'VERSION=$(VERSION)' 'MKDIR=$(MKDIR)' 'CP=$(CP)' archive; \
	done;

patchlist::
	@echo $(PFILES) > .patchlist


DTOP=$(ARCHIVE)-doc

docarchive::
	mkdir $(DTOP)
	$(CP) $(FILES) $(DTOP)
	$(CP) spoiler.ps handbook.ps $(DTOP)
	cp -r spell-docs spoiler-html playbook-html $(DTOP)
	(cd $(DTOP)/..; gtar --exclude=CVS -cvhzf $(VERSION).doc.tar.gz `$(BASENAME) $(DTOP)`)
	mv $(DTOP)/../$(VERSION).doc.tar.gz ./
	$(RM) -rf $(DTOP)

install::
	@if [ ! -d $(MAN1) ]; then \
		$(MKDIR) -p $(MAN1); \
	fi
	$(INSTALL) $(srcdir)/crossedit.man $(MAN1)/crossedit.$(MANSUFFIX)
	$(INSTALL) $(srcdir)/crossfire.man $(MAN1)/crossfire.$(MANSUFFIX)
